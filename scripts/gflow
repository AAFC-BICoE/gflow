#! /usr/bin/env python


import getopt
import sys
from gflow.gflow import GFlow


def parse_options():
    """
    Get the location of the config file from the command line.

    Returns:
        configfile (str): The file location parsed from the command line.
    """
    outstream = sys.stdout
    optstr = "h:"
    longopts = ["help"]
    (options, args) = getopt.getopt(sys.argv[1:], optstr, longopts)
    for key, value in options:
        if key in ("-h", "--help"):
            print_usage(outstream)
            sys.exit(0)
        else:
            pass
    config = None
    if len(args) > 0:
        config = args[0]
        try:
            instream = open(config, "r")
        except IOError as e:
            print >> sys.stderr, "ERROR: Cannot open output file %s" % config
            print >> sys.stderr, e
            sys.exit(1)
    elif not sys.stdin.isatty():
        instream = sys.stdin
    else:
        print >> sys.stderr, "ERROR: Please provide a config file"
        print_usage(sys.stderr)
        sys.exit(1)
    instream.close()
    return config


def print_usage(outstream):
    """
    Print usage when no config file is given or user users help flag.

    Args:
        outstream: Where to print the usage to.
    Returns:
        None
    """
    usage = ("Usage: gflow [options] config.txt\n"
             "  Options:\n"
             "    -h|--help           print this help message and exit")
    print >> outstream, usage
    return


# Main method for parsing the config file from the command and beginning the workflow.
if __name__ == '__main__':
    configfile = parse_options()
    gflow = GFlow(configfile)
    gflow.run_workflow()
